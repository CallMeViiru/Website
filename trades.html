<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="style.css"> <!-- same as index.css -->
</head>
<body>

<!-- HEADER -->
<header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon">
    <h1 id="HH1">Viiru</h1>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="Store.html">Store</a></li>
            <li><a href="Socials.html">Socials</a></li>
            <li><a href="about.html">About</a></li>
        </ul>
    </nav>
    <button id="darkModeToggle" aria-label="Toggle dark mode">ðŸŒ™</button>
</header>

<!-- TRADE FORM -->
<section class="recommended-products">
    <h2>Post a Trade</h2>
    <form id="tradeForm">
        <input type="text" id="username" placeholder="Your in-game username" required>

        <div class="multi-select">
            <div class="selectBox" onclick="toggleCheckboxes('giveBox')">Select items you give</div>
            <div class="checkboxes" id="giveBox"></div>
        </div>
        <input type="number" id="giveDiamonds" placeholder="Diamonds you give" min="0">

        <div class="multi-select">
            <div class="selectBox" onclick="toggleCheckboxes('wantBox')">Select items you want</div>
            <div class="checkboxes" id="wantBox"></div>
        </div>
        <input type="number" id="wantDiamonds" placeholder="Diamonds you want" min="0">

        <button type="submit">Post Trade</button>
    </form>
</section>

<!-- TRADE LIST -->
<section class="recommended-products">
    <h2>Available Trades</h2>
    <div id="tradeList" class="recommended-grid"></div>
</section>

<!-- FOOTER -->
<footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a>
    <a href="tos.html">Terms of Service</a>
</footer>

<script>
// Dark mode toggle
const toggleButton = document.getElementById('darkModeToggle');
toggleButton.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    toggleButton.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
});

// Multi-select toggle
function toggleCheckboxes(boxId){
    const box = document.getElementById(boxId);
    box.style.display = box.style.display === 'block' ? 'none' : 'block';
}

// Populate items
const allowedItems = ["Sword","Helmet","Shield","Potion","Bow","Armor"];
function populateItems(){
    const giveBox = document.getElementById("giveBox");
    const wantBox = document.getElementById("wantBox");
    allowedItems.forEach(i=>{
        giveBox.innerHTML += `<label><input type="checkbox" value="${i}"> ${i}</label>`;
        wantBox.innerHTML += `<label><input type="checkbox" value="${i}"> ${i}</label>`;
    });
}
populateItems();
</script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
  authDomain: "v11rutop.firebaseapp.com",
  projectId: "v11rutop",
  storageBucket: "v11rutop.firebasestorage.app",
  messagingSenderId: "664984661004",
  appId: "1:664984661004:web:357ea8a60723b000e55229",
  measurementId: "G-DMPEGNPVEN"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, user=>{
    if(user) currentUser=user;
    else alert("Login required to post trades!");
});

// Submit trade
document.getElementById("tradeForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!currentUser) return alert("Login required!");
    const username = document.getElementById("username").value;
    const giveItems = Array.from(document.querySelectorAll("#giveBox input:checked")).map(i=>i.value);
    const wantItems = Array.from(document.querySelectorAll("#wantBox input:checked")).map(i=>i.value);
    const giveDiamonds = parseInt(document.getElementById("giveDiamonds").value)||0;
    const wantDiamonds = parseInt(document.getElementById("wantDiamonds").value)||0;

    if(giveItems.length===0 && giveDiamonds===0) return alert("You must offer something!");
    if(wantItems.length===0 && wantDiamonds===0) return alert("You must request something!");

    // 24h cooldown
    const tradesRef = collection(db,"trades");
    const q = query(tradesRef, where("userId","==",currentUser.uid), orderBy("timestamp","desc"));
    const past = await getDocs(q);
    if(!past.empty){
        const lastTrade = past.docs[0].data().timestamp.toDate();
        if(Date.now() - lastTrade < 24*60*60*1000) return alert("One trade per 24h!");
    }

    await addDoc(tradesRef,{
        userId: currentUser.uid,
        username,
        giveItems,
        wantItems,
        giveDiamonds,
        wantDiamonds,
        timestamp: serverTimestamp()
    });

    alert("Trade posted!");
    loadTrades();
});

// Load trades
async function loadTrades(){
    const tradeList = document.getElementById("tradeList");
    tradeList.innerHTML="";
    const tradesRef = collection(db,"trades");
    const snapshot = await getDocs(tradesRef);
    snapshot.forEach(doc=>{
        const t = doc.data();
        const html = `
        <div class="product-box">
            <h3>${t.username}</h3>
            <p>Gives: ${t.giveItems.join(", ")} ${t.giveDiamonds>0? `+ ${t.giveDiamonds} diamonds`:""}</p>
            <p>Wants: ${t.wantItems.join(", ")} ${t.wantDiamonds>0? `+ ${t.wantDiamonds} diamonds`:""}</p>
        </div>`;
        tradeList.innerHTML += html;
    });
}
loadTrades();
</script>

</body>
</html>

</body>
</html>
