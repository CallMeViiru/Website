<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trades | Viiru</title>
  <link rel="stylesheet" href="trades.css">
</head>
<body>
  <!-- Header -->
  <header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon" />
    <h1 id="HH1">Viiru Trades</h1>
    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
        <li><a href="https://www.viiru.top/trades" class="active">Trades</a></li>
      </ul>
    </nav>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </header>

  <!-- Trade Form -->
  <section class="textsection">
    <h2>Post Your Trade</h2>
    <form id="tradeForm">
      <label>In-game Username</label>
      <input type="text" id="username" placeholder="Your Minecraft username" required>

      <label>Items You Offer</label>
      <select id="offerItems" multiple required></select>
      <input type="number" id="offerDiamonds" placeholder="Diamonds you give" min="0">

      <label>Items You Want</label>
      <select id="wantItems" multiple required></select>
      <input type="number" id="wantDiamonds" placeholder="Diamonds you want" min="0">

      <button type="submit">Post Trade</button>
      <p id="cooldownMsg"></p>
    </form>
  </section>

  <!-- Trades Display -->
  <section class="textsection">
    <h2>Latest Trades</h2>
    <div id="tradesList"></div>
  </section>

  <!-- Footer -->
  <footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="https://www.viiru.top/privacypolicy" style="color: rgb(124, 176, 243); margin-right: 15px;">Privacy Policy</a>
    <a href="https://www.viiru.top/tos" style="color: rgb(124, 176, 243);">Terms of Service</a>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
      authDomain: "v11rutop.firebaseapp.com",
      projectId: "v11rutop",
      storageBucket: "v11rutop.firebasestorage.app",
      messagingSenderId: "664984661004",
      appId: "1:664984661004:web:357ea8a60723b000e55229",
      measurementId: "G-DMPEGNPVEN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const form = document.getElementById("tradeForm");
    const cooldownMsg = document.getElementById("cooldownMsg");
    const tradesList = document.getElementById("tradesList");

    let currentUser = null;

    // Login / Logout
    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        currentUser = null;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    });

    // Trade Form Submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        cooldownMsg.textContent = "You must log in to post a trade.";
        return;
      }

      // 24h cooldown (localStorage)
      const lastTrade = localStorage.getItem("lastTradeTime");
      const now = Date.now();
      if (lastTrade && now - lastTrade < 24 * 60 * 60 * 1000) {
        cooldownMsg.textContent = "You can only post once every 24 hours.";
        return;
      }

      const username = document.getElementById("username").value;
      const offerItems = Array.from(document.getElementById("offerItems").selectedOptions).map(opt => opt.value);
      const wantItems = Array.from(document.getElementById("wantItems").selectedOptions).map(opt => opt.value);
      const offerDiamonds = document.getElementById("offerDiamonds").value;
      const wantDiamonds = document.getElementById("wantDiamonds").value;

      try {
        await addDoc(collection(db, "trades"), {
          username,
          offerItems,
          offerDiamonds,
          wantItems,
          wantDiamonds,
          userId: currentUser.uid,
          createdAt: serverTimestamp()
        });
        localStorage.setItem("lastTradeTime", now);
        form.reset();
        cooldownMsg.textContent = "‚úÖ Trade posted!";
      } catch (err) {
        console.error("Error adding trade:", err);
      }
    });

    // Live trades
    const q = query(collection(db, "trades"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      tradesList.innerHTML = "";
      snapshot.forEach((doc) => {
        const trade = doc.data();
        const div = document.createElement("div");
        div.className = "product-box";
        div.innerHTML = `
          <p><strong>${trade.username}</strong></p>
          <p>Offers: ${trade.offerItems.join(", ")} ${trade.offerDiamonds ? `+ ${trade.offerDiamonds} üíé` : ""}</p>
          <p>Wants: ${trade.wantItems.join(", ")} ${trade.wantDiamonds ? `+ ${trade.wantDiamonds} üíé` : ""}</p>
        `;
        tradesList.appendChild(div);
      });
    });

    // Load allowed items from JSON
    fetch("items.json")
      .then(res => res.json())
      .then(items => {
        const offerSelect = document.getElementById("offerItems");
        const wantSelect = document.getElementById("wantItems");
        items.forEach(item => {
          const option1 = document.createElement("option");
          option1.value = item;
          option1.textContent = item;
          offerSelect.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = item;
          option2.textContent = item;
          wantSelect.appendChild(option2);
        });
      });
  </script>
  <script>
  const toggleButton = document.getElementById('darkModeToggle');

  if (toggleButton) {
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');

      // Switch icons
      if (document.body.classList.contains('dark-mode')) {
        toggleButton.textContent = '‚òÄÔ∏è'; // Sun
      } else {
        toggleButton.textContent = 'üåô'; // Moon
      }
    });
  }
</script>
</body>
</html>