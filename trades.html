<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="trades.css">
</head>
<body>
    <!-- HEADER -->
    <header id="header">
        <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon" />
        <h1 id="HH1">Viiru</h1>
        <nav>
            <ul>
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="Store.html">Store</a></li>
                <li><a href="Socials.html">Socials</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
        <div id="user-info"></div>
        <button id="darkModeToggle" title="Toggle dark mode">üåô</button>
    </header>

    <!-- TRADE FORM SECTION -->
    <section class="trade-section">
        <h2>Post a Trade</h2>
        <p id="login-message">Please log in to post a trade.</p>
        
        <form id="trade-form">
            <label>Your Username:</label>
            <input type="text" id="username" placeholder="In-game username" required>

            <label>Items You Offer:</label>
            <select id="offer-items" multiple required></select>
            <input type="number" id="offer-amounts" placeholder="Amounts separated by commas" required>

            <label>Items You Want:</label>
            <select id="want-items" multiple required></select>
            <input type="number" id="want-amounts" placeholder="Amounts separated by commas" required>

            <button type="submit">Post Trade</button>
        </form>
    </section>

    <!-- TRADE LIST -->
    <section class="trade-list">
        <h2>Active Trades</h2>
        <div id="trade-container"></div>
    </section>

    <!-- FOOTER -->
    <footer id="footer">
        <p>Copyright &copy; viiru.top 2025</p>
        <a href="privacypolicy.html">Privacy Policy</a>
        <a href="tos.html">Terms of Service</a>
    </footer>

    <!-- SCRIPTS -->
    <script type="module">
        // Firebase setup
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
            authDomain: "v11rutop.firebaseapp.com",
            projectId: "v11rutop",
            storageBucket: "v11rutop.firebasestorage.app",
            messagingSenderId: "664984661004",
            appId: "1:664984661004:web:357ea8a60723b000e55229",
            measurementId: "G-DMPEGNPVEN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const tradeForm = document.getElementById("trade-form");
        const tradeContainer = document.getElementById("trade-container");
        const userInfoDiv = document.getElementById("user-info");
        const loginMessage = document.getElementById("login-message");
        const offerSelect = document.getElementById("offer-items");
        const wantSelect = document.getElementById("want-items");
        const usernameInput = document.getElementById("username");

        // PREMADE ITEMS
        const items = ["Sword", "Helmet", "Shield", "Potion", "Bow", "Armor"];

        function populateItems() {
            items.forEach(item => {
                const option1 = document.createElement("option");
                option1.value = item;
                option1.textContent = item;
                offerSelect.appendChild(option1);

                const option2 = document.createElement("option");
                option2.value = item;
                option2.textContent = item;
                wantSelect.appendChild(option2);
            });
        }
        populateItems();

        let currentUser = null;

        // AUTH STATE
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userInfoDiv.innerHTML = `Logged in as: <span>${user.displayName}</span> <button id="logout">Logout</button>`;
                loginMessage.style.display = "none";

                document.getElementById("logout").addEventListener("click", () => {
                    auth.signOut().then(() => location.reload());
                });
            } else {
                loginMessage.style.display = "block";
            }
        });

        // POST TRADE
        tradeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!currentUser) return alert("Please log in first.");

            const username = usernameInput.value.trim();
            const offerItems = Array.from(offerSelect.selectedOptions).map(o => o.value);
            const offerAmounts = document.getElementById("offer-amounts").value.split(",").map(a => parseInt(a.trim()));
            const wantItems = Array.from(wantSelect.selectedOptions).map(o => o.value);
            const wantAmounts = document.getElementById("want-amounts").value.split(",").map(a => parseInt(a.trim()));

            if (offerItems.length !== offerAmounts.length || wantItems.length !== wantAmounts.length) {
                return alert("Please provide amounts for each selected item.");
            }

            try {
                await addDoc(collection(db, "trades"), {
                    username,
                    userId: currentUser.uid,
                    offerItems,
                    offerAmounts,
                    wantItems,
                    wantAmounts,
                    timestamp: Timestamp.now()
                });
                alert("Trade posted!");
                tradeForm.reset();
                loadTrades();
            } catch (err) {
                console.error(err);
                alert("Error posting trade");
            }
        });

        // LOAD TRADES
        async function loadTrades() {
            tradeContainer.innerHTML = "";
            const querySnapshot = await getDocs(collection(db, "trades"));
            querySnapshot.forEach(doc => {
                const trade = doc.data();
                const tradeDiv = document.createElement("div");
                tradeDiv.classList.add("trade-box");
                tradeDiv.innerHTML = `
                    <h3>${trade.username}'s Trade</h3>
                    <p><strong>Offers:</strong> ${trade.offerItems.map((i, idx) => `${i} x${trade.offerAmounts[idx]}`).join(", ")}</p>
                    <p><strong>Wants:</strong> ${trade.wantItems.map((i, idx) => `${i} x${trade.wantAmounts[idx]}`).join(", ")}</p>
                `;
                tradeContainer.appendChild(tradeDiv);
            });
        }

        loadTrades();

        // DARK MODE TOGGLE
        const toggleButton = document.getElementById('darkModeToggle');
        toggleButton.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            toggleButton.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        });
    </script>
</body>
</html>
