<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="trades.css">
</head>
<body>

<header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon" />
    <h1 id="HH1">Viiru</h1>
    <nav>
        <ul>
            <li><a href="https://www.viiru.top/" >Home</a></li>
            <li><a href="https://www.viiru.top/Store">Store</a></li>
            <li><a href="https://www.viiru.top/Socials">Socials</a></li>
            <li><a href="https://www.viiru.top/about">About</a></li>
        </ul>
    </nav>
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle dark mode">🌙</button>
</header>

<section class="textsection">
    <h2>Post a Trade</h2>
    <form id="tradeForm">
        <div>
            <label>Items you offer:</label>
            <div class="checkboxes" id="offerItems">
                <label><input type="checkbox" value="Sword"> Sword</label>
                <label><input type="checkbox" value="Shield"> Shield</label>
                <label><input type="checkbox" value="Helmet"> Helmet</label>
            </div>
        </div>
        <input type="number" id="offerDiamonds" placeholder="Diamonds you give">
        
        <div>
            <label>Items you want:</label>
            <div class="checkboxes" id="requestItems">
                <label><input type="checkbox" value="Sword"> Sword</label>
                <label><input type="checkbox" value="Shield"> Shield</label>
                <label><input type="checkbox" value="Helmet"> Helmet</label>
            </div>
        </div>
        <input type="number" id="requestDiamonds" placeholder="Diamonds you want">
        <button type="submit">Post Trade</button>
    </form>
    <button id="loginBtn"></button>
</section>

<section class="textsection">
    <h2>Live Trades</h2>
    <div id="tradesList"></div>
</section>

<footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="https://www.viiru.top/privacypolicy">Privacy Policy</a>
    <a href="https://www.viiru.top/tos">Terms of Service</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
  authDomain: "v11rutop.firebaseapp.com",
  projectId: "v11rutop",
  storageBucket: "v11rutop.firebasestorage.app",
  messagingSenderId: "664984661004",
  appId: "1:664984661004:web:357ea8a60723b000e55229",
  measurementId: "G-DMPEGNPVEN"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const tradeForm = document.getElementById('tradeForm');
const tradesList = document.getElementById('tradesList');
const loginBtn = document.getElementById('loginBtn');

// Dark mode toggle
const toggleButton = document.getElementById('darkModeToggle');
toggleButton.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    toggleButton.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
});

// Handle login/logout
onAuthStateChanged(auth, user => {
    if(user){
        loginBtn.textContent = 'Logout';
        loginBtn.onclick = () => signOut(auth);
    } else {
        loginBtn.textContent = 'Login';
        loginBtn.onclick = () => signInWithPopup(auth, provider);
    }
});

// Post trade
tradeForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const offeredItems = Array.from(document.querySelectorAll('#offerItems input:checked')).map(i => i.value);
    const requestedItems = Array.from(document.querySelectorAll('#requestItems input:checked')).map(i => i.value);
    const offeredDiamonds = parseInt(document.getElementById('offerDiamonds').value) || 0;
    const requestedDiamonds = parseInt(document.getElementById('requestDiamonds').value) || 0;

    const user = auth.currentUser;
    if(!user){
        alert('You must be logged in to post a trade!');
        return;
    }

    try{
        await addDoc(collection(db, 'trades'), {
            userId: user.uid,
            username: user.displayName || user.email,
            offeredItems,
            requestedItems,
            offeredDiamonds,
            requestedDiamonds,
            timestamp: serverTimestamp()
        });
        tradeForm.reset();
    } catch(err){
        console.error(err);
        alert('Error posting trade.');
    }
});

// Listen for live trades
const q = query(collection(db, 'trades'), orderBy('timestamp', 'desc'));
onSnapshot(q, snapshot => {
    tradesList.innerHTML = '';
    snapshot.forEach(doc => {
        const data = doc.data();
        const tradeHTML = `
            <div class="product-box">
                <p><strong>${data.username}</strong></p>
                <p>Offer: ${data.offeredItems.join(', ')}${data.offeredDiamonds > 0 ? ' + ' + data.offeredDiamonds + ' diamonds' : ''}</p>
                <p>Want: ${data.requestedItems.join(', ')}${data.requestedDiamonds > 0 ? ' + ' + data.requestedDiamonds + ' diamonds' : ''}</p>
            </div>
        `;
        tradesList.innerHTML += tradeHTML;
    });
});
</script>
</body>
</html>
