<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viiru Â· Trades</title>
  <link rel="icon" href="Images/Viiru.png" />
  <link rel="stylesheet" href="trades.css" />
</head>
<body>

  <!-- HEADER -->
  <header id="header">
    <div class="left-h">
      <img id="HIcon" src="Images/Viiru.png" alt="Viiru logo" />
      <h1 id="HH1">Viiru</h1>
    </div>

    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
      </ul>
    </nav>

    <div class="right-h">
      <button id="darkModeToggle" title="Toggle dark mode">ðŸŒ™</button>
      <button id="loginBtn" class="primary">Login</button>
    </div>
  </header>

  <!-- TRADE FORM -->
  <main>
    <section class="trade-section">
      <h2>Post Your CatCraft Trade</h2>

      <div id="auth-area" class="auth-area">
        <div id="user-info" class="user-info" style="display:none">
          <span id="user-display"></span>
        </div>
        <div id="auth-buttons" class="auth-buttons">
          <button id="openAuthBtn" class="secondary">Sign in / Sign up</button>
        </div>
      </div>

      <form id="tradeForm" class="trade-form" style="display:none" autocomplete="off">
        <label for="ingameName">In-game name</label>
        <input id="ingameName" type="text" placeholder="Your in-game name" required />

        <!-- Offer items dropdown -->
        <label>Items you OFFER</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="offer-list">Select offered items â–¾</button>
          <div class="dropdown-content" id="offer-list" aria-hidden="true"></div>
        </div>

        <!-- Diamonds offer -->
        <label for="offerDiamonds">Diamonds you OFFER</label>
        <input id="offerDiamonds" type="number" min="0" value="0" placeholder="0 ðŸ’Ž" />

        <!-- Want items dropdown -->
        <label>Items you WANT</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="want-list">Select wanted items â–¾</button>
          <div class="dropdown-content" id="want-list" aria-hidden="true"></div>
        </div>

        <!-- Diamonds want -->
        <label for="wantDiamonds">Diamonds you WANT</label>
        <input id="wantDiamonds" type="number" min="0" value="0" placeholder="0 ðŸ’Ž" />

        <div class="form-row">
          <button id="postTradeBtn" type="submit" class="primary">Post Trade</button>
          <button id="clearFormBtn" type="button" class="secondary">Clear</button>
        </div>

        <p id="formNote" class="note">You can post one trade every 24 hours.</p>
      </form>
    </section>

    <!-- FILTER TRADES -->
    <section class="filter-section">
      <h2>Filter Trades</h2>
      <div class="dropdown-checkbox">
        <button type="button" class="dropbtn" data-target="filter-list">Select items to filter â–¾</button>
        <div class="dropdown-content" id="filter-list" aria-hidden="true"></div>
      </div>
      <button id="applyFilterBtn" class="secondary">Apply Filter</button>
      <button id="clearFilterBtn" class="secondary">Clear Filter</button>
    </section>

    <!-- LIVE TRADES -->
    <section class="live-trades">
      <h2>Live Trades</h2>
      <div id="tradesContainer" class="trades-container"></div>
    </section>
  </main>

  <footer id="footer">
    <p>Copyright &copy; viiru.top & viiru.ee 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a> |
    <a href="tos.html">Terms Of Service</a>
  </footer>

  <!-- Firebase + App logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, setDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, onAuthStateChanged, signInAnonymously, updateProfile
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
    authDomain: "v11rutop.firebaseapp.com",
    projectId: "v11rutop",
    storageBucket: "v11rutop.firebasestorage.app",
    messagingSenderId: "664984661004",
    appId: "1:664984661004:web:357ea8a60723b000e55229"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const googleProvider = new GoogleAuthProvider();

  // DOM references
  const tradesContainer = document.getElementById('tradesContainer');
  const filterList = document.getElementById('filter-list');
  const applyFilterBtn = document.getElementById('applyFilterBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');

  // Items
  const ITEMS = [
    { id: 'sefu_clone', name: 'Sefu Clone' },
    { id: 'sefu', name: 'Sefu' },
    { id: 'aisha_pickaxe', name: 'Aisha Pickaxe' },
    { id: 'freyja_crossbow', name: 'Freyja Crossbow' },
    { id: 'shulker_helmet', name: 'Shulker Helmet' },
    { id: 'shulker_chestplate', name: 'Shulker Chestplate' },
    { id: 'shulker_leggings', name: 'Shulker Leggings' },
    { id: 'shulker_boots', name: 'Shulker Boots' }
  ];

  // Populate filter list
  function populateFilterList() {
    filterList.innerHTML = '';
    ITEMS.forEach(it => {
      const label = document.createElement('label');
      label.className = 'item-row';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.item = it.id;
      cb.dataset.itemName = it.name;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(it.name));
      filterList.appendChild(label);
    });
  }
  populateFilterList();

  // Current filter
  let activeFilter = [];

  applyFilterBtn.addEventListener('click', () => {
    activeFilter = Array.from(document.querySelectorAll('#filter-list input:checked'))
      .map(cb => cb.dataset.itemName);
    renderTrades(lastTrades);
  });

  clearFilterBtn.addEventListener('click', () => {
    activeFilter = [];
    document.querySelectorAll('#filter-list input').forEach(cb => cb.checked = false);
    renderTrades(lastTrades);
  });

  // Live trades + filtering
  let lastTrades = [];
  const tradesQuery = query(collection(db, 'trades'), orderBy('createdAt','desc'));
  onSnapshot(tradesQuery, snapshot => {
    lastTrades = snapshot.docs.map(doc => doc.data());
    renderTrades(lastTrades);
  });

  function renderTrades(trades) {
    tradesContainer.innerHTML = '';
    trades.forEach(t => {
      if (activeFilter.length > 0) {
        const allItems = [
          ...(t.offerItems || []).map(it => it.name),
          ...(t.wantItems || []).map(it => it.name)
        ];
        if (!activeFilter.some(f => allItems.includes(f))) return;
      }

      const card = document.createElement('div');
      card.className = 'trade-card';
      const formatList = arr => arr.map(it => `${it.qty}Ã— ${it.name}`).join(', ') || 'â€”';
      card.innerHTML = `
        <h4>${t.authorName || 'Unknown'}</h4>
        <p><strong>Offers:</strong> ${formatList(t.offerItems)} ${t.offerDiamonds ? 'ðŸ’Ž'+t.offerDiamonds : ''}</p>
        <p><strong>Wants:</strong> ${formatList(t.wantItems)} ${t.wantDiamonds ? 'ðŸ’Ž'+t.wantDiamonds : ''}</p>
        <p class="timestamp">${t.createdAt?.toDate().toLocaleString() || ''}</p>
      `;
      tradesContainer.appendChild(card);
    });
  }
  </script>
</body>
</html>
