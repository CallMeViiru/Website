<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viiru · Trades</title>
  <link rel="icon" href="Images/Viiru.png" />
  <link rel="stylesheet" href="trades.css" />
</head>
<body>

  <!-- HEADER -->
  <header id="header">
    <div class="left-h">
      <img id="HIcon" src="Images/Viiru.png" alt="Viiru logo" />
      <h1 id="HH1">Viiru</h1>
    </div>

    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
      </ul>
    </nav>

    <div class="right-h">
      <button id="darkModeToggle" title="Toggle dark mode">🌙</button>
      <button id="loginBtn" class="primary">Login</button>
    </div>
  </header>

  <!-- TRADE FORM -->
  <main>
    <section class="trade-section">
      <h2>Post Your CatCraft Trade</h2>

      <div id="auth-area" class="auth-area">
        <div id="user-info" class="user-info" style="display:none">
          <span id="user-display"></span>
        </div>
      </div>

      <form id="tradeForm" class="trade-form" style="display:none" autocomplete="off">
        <label for="ingameName">In-game name</label>
        <input id="ingameName" type="text" placeholder="Your in-game name" required />

        <!-- Offer items dropdown -->
        <label>Items you OFFER</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="offer-list">Select offered items ▾</button>
          <div class="dropdown-content" id="offer-list" aria-hidden="true"></div>
        </div>

        <label for="offerDiamonds">Diamonds you OFFER</label>
        <input id="offerDiamonds" type="number" min="0" value="0" placeholder="0 💎" />

        <!-- Want items dropdown -->
        <label>Items you WANT</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="want-list">Select wanted items ▾</button>
          <div class="dropdown-content" id="want-list" aria-hidden="true"></div>
        </div>

        <label for="wantDiamonds">Diamonds you WANT</label>
        <input id="wantDiamonds" type="number" min="0" value="0" placeholder="0 💎" />

        <div class="form-row">
          <button id="postTradeBtn" type="submit" class="primary">Post Trade</button>
          <button id="clearFormBtn" type="button" class="secondary">Clear</button>
        </div>

        <p id="formNote" class="note">You can post one trade every 24 hours.</p>
      </form>
    </section>

    <!-- FILTER SECTION -->
    <section class="filter-section">
      <h2>Filter Trades</h2>
      <div class="dropdown-checkbox">
        <button type="button" class="dropbtn" data-target="filter-list">Filter by items ▾</button>
        <div class="dropdown-content" id="filter-list" aria-hidden="true"></div>
      </div>
    </section>

    <!-- LIVE TRADES -->
    <section class="live-trades">
      <h2>Live Trades</h2>
      <div id="tradesContainer" class="trades-container"></div>
    </section>
  </main>

  <footer id="footer">
    <p>Copyright &copy; viiru.top & viiru.ee 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a> |
    <a href="tos.html">Terms Of Service</a>
  </footer>

  <!-- Firebase + Logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, setDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup,
    signInAnonymously, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
    authDomain: "v11rutop.firebaseapp.com",
    projectId: "v11rutop",
    storageBucket: "v11rutop.firebasestorage.app",
    messagingSenderId: "664984661004",
    appId: "1:664984661004:web:357ea8a60723b000e55229"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const googleProvider = new GoogleAuthProvider();

  const loginBtn = document.getElementById('loginBtn');
  const tradeForm = document.getElementById('tradeForm');
  const ingameName = document.getElementById('ingameName');
  const offerList = document.getElementById('offer-list');
  const wantList = document.getElementById('want-list');
  const offerDiamonds = document.getElementById('offerDiamonds');
  const wantDiamonds = document.getElementById('wantDiamonds');
  const tradesContainer = document.getElementById('tradesContainer');
  const filterList = document.getElementById('filter-list');
  const darkModeToggle = document.getElementById('darkModeToggle');

  const ITEMS = [
    { id: 'sefu_clone', name: 'Sefu Clone' },
    { id: 'sefu', name: 'Sefu' },
    { id: 'aisha_pickaxe', name: 'Aisha Pickaxe' },
    { id: 'freyja_crossbow', name: 'Freyja Crossbow' },
    { id: 'shulker_helmet', name: 'Shulker Helmet' },
    { id: 'shulker_chestplate', name: 'Shulker Chestplate' },
    { id: 'shulker_leggings', name: 'Shulker Leggings' },
    { id: 'shulker_boots', name: 'Shulker Boots' }
  ];

  function makeItemRow(itemId, itemName, listId) {
    const label = document.createElement('label');
    label.className = 'item-row';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'item-cb';
    cb.dataset.item = itemId;
    cb.dataset.itemName = itemName;
    const span = document.createElement('span');
    span.textContent = itemName;
    const qty = document.createElement('input');
    qty.type = 'number';
    qty.min = 1;
    qty.value = 1;
    qty.disabled = true;
    qty.style.width = '60px';
    cb.addEventListener('change',()=>{ qty.disabled=!cb.checked; updateDropdownButtonText(listId); });
    qty.addEventListener('input',()=>updateDropdownButtonText(listId));
    label.appendChild(cb); label.appendChild(span); label.appendChild(qty);
    return label;
  }

  function populateItemLists() {
    offerList.innerHTML = '';
    wantList.innerHTML = '';
    filterList.innerHTML = '';
    ITEMS.forEach(it => {
      offerList.appendChild(makeItemRow(it.id, it.name, 'offer-list'));
      wantList.appendChild(makeItemRow(it.id, it.name, 'want-list'));
      const lbl = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.className='filter-cb'; cb.value=it.id; cb.dataset.itemName=it.name;
      lbl.appendChild(cb); lbl.appendChild(document.createTextNode(it.name));
      filterList.appendChild(lbl);
    });
  }
  populateItemLists();

  document.querySelectorAll('.dropbtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const targetId=btn.dataset.target;
      const parent=btn.parentElement;
      parent.classList.toggle('show');
      updateDropdownButtonText(targetId);
    });
  });
  window.addEventListener('click',e=>{
    document.querySelectorAll('.dropdown-checkbox').forEach(drop=>{
      if(!drop.contains(e.target)) drop.classList.remove('show');
    });
  });

  function updateDropdownButtonText(listId){
    const parent=document.querySelector(`[data-target="${listId}"]`)?.parentElement;
    const btn=parent?.querySelector('.dropbtn');
    if(!btn)return;
    const checked=Array.from(document.querySelectorAll(`#${listId} .item-cb`)).filter(c=>c.checked);
    if(checked.length===0){ btn.textContent=(listId==='offer-list')?'Select offered items ▾':(listId==='want-list')?'Select wanted items ▾':'Filter by items ▾'; return;}
    const names=checked.map(c=>{
      const qty=c.parentElement.querySelector('.item-qty')?.value||1;
      return `${qty}× ${c.dataset.itemName}`;
    });
    btn.textContent=names.slice(0,3).join(', ')+(names.length>3?' … ▾':' ▾');
  }

  onAuthStateChanged(auth,user=>{
    if(user){ loginBtn.textContent='Logout'; tradeForm.style.display='block'; if(!ingameName.value) ingameName.value=user.displayName||'';
    } else { loginBtn.textContent='Login'; tradeForm.style.display='none'; }
  });

  loginBtn.addEventListener('click',async()=>{
    if(auth.currentUser){ await signOut(auth); }
    else { await signInAnonymously(auth); }
  });

  function collectSelectedItems(listId){
    return Array.from(document.querySelectorAll(`#${listId} .item-row`)).filter(r=>r.querySelector('.item-cb').checked).map(r=>{
      return { id:r.querySelector('.item-cb').dataset.item, name:r.querySelector('.item-cb').dataset.itemName, qty:parseInt(r.querySelector('.item-qty').value)||1 };
    });
  }

  async function getLastTradeTime(uid){ const snap=await getDoc(doc(db,'users',uid)); return snap.exists()?snap.data().lastTrade||0:0; }
  async function setLastTradeTime(uid,ts){ await setDoc(doc(db,'users',uid),{lastTrade:ts},{merge:true}); }

  tradeForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const user=auth.currentUser; if(!user){alert('You must be logged in.');return;}
    const last=await getLastTradeTime(user.uid); const now=Date.now(); const DAY=86400000;
    if(now-last<DAY){ alert('24h cooldown not passed.'); return; }
    const trade={ uid:user.uid, authorName:ingameName.value||'Anonymous', offerItems:collectSelectedItems('offer-list'),
      wantItems:collectSelectedItems('want-list'), offerDiamonds:parseInt(offerDiamonds.value)||0, wantDiamonds:parseInt(wantDiamonds.value)||0, createdAt:serverTimestamp()};
    await addDoc(collection(db,'trades'),trade); await setLastTradeTime(user.uid,now); alert('Trade posted!');
    tradeForm.reset(); populateItemLists();
  });

  function escapeHtml(str){ if(!str)return''; return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

  let allTrades=[];
  function passesFilter(trade){
    const selected=Array.from(document.querySelectorAll('.filter-cb:checked')).map(cb=>cb.value);
    if(selected.length===0)return true;
    const ids=[...(trade.offerItems||[]).map(it=>it.id),...(trade.wantItems||[]).map(it=>it.id)];
    return selected.some(id=>ids.includes(id));
  }
  function renderTrades(){
    tradesContainer.innerHTML='';
    allTrades.forEach(t=>{
      if(!passesFilter(t))return;
      const card=document.createElement('div');
      card.className='trade-card';
      const formatList=arr=>arr.map(it=>`${it.qty}× ${it.name}`).join(', ')||'—';
      const createdAtText=t.createdAt?.toDate?t.createdAt.toDate().toLocaleString():'';
      card.innerHTML=`<h4>${escapeHtml(t.authorName)}</h4>
      <p><strong>Offers:</strong> ${escapeHtml(formatList(t.offerItems||[]))} ${t.offerDiamonds?'💎'+t.offerDiamonds:''}</p>
      <p><strong>Wants:</strong> ${escapeHtml(formatList(t.wantItems||[]))} ${t.wantDiamonds?'💎'+t.wantDiamonds:''}</p>
      <p class="meta">${escapeHtml(createdAtText)}</p>`;
      tradesContainer.appendChild(card);
    });
  }
  const tradesQuery=query(collection(db,'trades'),orderBy('createdAt','desc'));
  onSnapshot(tradesQuery,snap=>{ allTrades=[]; snap.forEach(doc=>allTrades.push(doc.data())); renderTrades(); });
  filterList.addEventListener('change',()=>{ updateDropdownButtonText('filter-list'); renderTrades(); });

  darkModeToggle.addEventListener('click',()=>{ document.body.classList.toggle('dark-mode'); darkModeToggle.textContent=document.body.classList.contains('dark-mode')?'☀️':'🌙'; });
  </script>

</body>
</html>
