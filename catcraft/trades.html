<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viiru | Trades</title>
  <link rel="stylesheet" href="trades.css" />
</head>
<body>
  <!-- Header -->
  <header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon" />
    <h1 id="HH1">Viiru</h1>
    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
        <li><a href="https://www.viiru.top/trades" class="active">Trades</a></li>
      </ul>
    </nav>
    <button id="darkModeToggle">ðŸŒ™</button>
    <button id="loginBtn">Login</button>
  </header>

  <main>
    <section class="trade-section">
      <h2>Post a Trade</h2>
      <form id="trade-form">
        <input type="text" id="ingameName" placeholder="Your In-Game Name" required>

        <label>What do you offer?</label>
        <div class="dropdown" id="offer-list"></div>
        <input type="number" id="offerDiamonds" placeholder="ðŸ’Ž Diamonds you offer" min="0">

        <label>What do you want?</label>
        <div class="dropdown" id="want-list"></div>
        <input type="number" id="wantDiamonds" placeholder="ðŸ’Ž Diamonds you want" min="0">

        <button type="submit">Post Trade</button>
      </form>
    </section>

    <section class="trade-section">
      <h2>Live Trades</h2>
      <div id="trade-list"></div>
    </section>
  </main>

  <footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="https://www.viiru.top/privacypolicy">Privacy Policy</a> |
    <a href="https://www.viiru.top/tos">Terms of Service</a>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
      authDomain: "v11rutop.firebaseapp.com",
      projectId: "v11rutop",
      storageBucket: "v11rutop.firebasestorage.app",
      messagingSenderId: "664984661004",
      appId: "1:664984661004:web:357ea8a60723b000e55229",
      measurementId: "G-DMPEGNPVEN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    const loginBtn = document.getElementById('loginBtn');
    const tradeForm = document.getElementById('trade-form');
    const tradeList = document.getElementById('trade-list');
    const ingameName = document.getElementById('ingameName');
    const offerDiamonds = document.getElementById('offerDiamonds');
    const wantDiamonds = document.getElementById('wantDiamonds');

    // Local cooldown
    function getLastTradeTime(uid) {
      return parseInt(localStorage.getItem(`trade_${uid}`)) || 0;
    }
    function setLastTradeTime(uid, time) {
      localStorage.setItem(`trade_${uid}`, time);
    }

    // Items
    const items = ["Sword", "Helmet", "Pickaxe", "Shovel", "Bow"];

    function populateItemLists() {
      ["offer-list", "want-list"].forEach(id => {
        const container = document.getElementById(id);
        container.innerHTML = "";
        items.forEach(item => {
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" value="${item}"> ${item}`;
          container.appendChild(label);
        });
      });
    }
    populateItemLists();

    function collectSelectedItems(id) {
      return Array.from(document.querySelectorAll(`#${id} input:checked`))
        .map(cb => cb.value);
    }

    // Auth
    onAuthStateChanged(auth, user => {
      if (user) {
        loginBtn.textContent = 'Logout';
        tradeForm.style.display = 'block';
      } else {
        loginBtn.textContent = 'Login';
        tradeForm.style.display = 'none';
      }
    });

    loginBtn.addEventListener('click', async () => {
      if (auth.currentUser) {
        await signOut(auth);
        return;
      }
      const choice = confirm("Press OK to login with Google, or Cancel for anonymous login.");
      try {
        if (choice) {
          await signInWithPopup(auth, googleProvider);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    });

    // Trade form
    tradeForm.addEventListener('submit', async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to post a trade.');
        return;
      }
      const ign = ingameName.value.trim();
      if (!ign) {
        alert("Please enter your in-game name.");
        return;
      }

      const last = getLastTradeTime(user.uid);
      const now = Date.now();
      if (now - last < 86400000) {
        alert("You can only post once every 24 hours.");
        return;
      }

      const trade = {
        uid: user.uid,
        authorName: ign,
        offerItems: collectSelectedItems('offer-list'),
        wantItems: collectSelectedItems('want-list'),
        offerDiamonds: parseInt(offerDiamonds.value) || 0,
        wantDiamonds: parseInt(wantDiamonds.value) || 0,
        createdAt: serverTimestamp()
      };

      await addDoc(collection(db, "trades"), trade);
      setLastTradeTime(user.uid, now);
      alert("Trade posted!");
      tradeForm.reset();
      populateItemLists();
    });

    // Live trades
    onSnapshot(collection(db, "trades"), snapshot => {
      tradeList.innerHTML = "";
      snapshot.forEach(doc => {
        const trade = doc.data();
        const div = document.createElement("div");
        div.className = "trade-box";
        div.innerHTML = `
          <strong>${trade.authorName}</strong><br>
          Offers: ${trade.offerItems.join(", ")} ${trade.offerDiamonds ? `+ ðŸ’Ž ${trade.offerDiamonds}` : ""}<br>
          Wants: ${trade.wantItems.join(", ")} ${trade.wantDiamonds ? `+ ðŸ’Ž ${trade.wantDiamonds}` : ""}
        `;
        tradeList.appendChild(div);
      });
    });
  </script>
</body>
</html>
