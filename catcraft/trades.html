<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viiru ¬∑ Trades</title>
  <link rel="icon" href="Images/Viiru.png" />
  <link rel="stylesheet" href="trades.css" />
</head>
<body>

  <!-- HEADER -->
  <header id="header">
    <div class="left-h">
      <img id="HIcon" src="Images/Viiru.png" alt="Viiru logo" />
      <h1 id="HH1">Viiru</h1>
    </div>

    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
      </ul>
    </nav>

    <div class="right-h">
      <button id="darkModeToggle" title="Toggle dark mode">üåô</button>
      <button id="loginBtn" class="primary">Login</button>
    </div>
  </header>

  <!-- TRADE FORM -->
  <main>

    <!--  Text section -->
  <section class="textsection">
    <h2>IMPORTANT</h2>
    <p>Do not post trades you won't accept and always use your own username and no "test" names. The item list is put together by Guncat and BIG shoutout to them!</p>
  </section>
    
    <section class="trade-section">
      <h2>Post Your CatCraft Trade</h2>

      <div id="auth-area" class="auth-area">
        <div id="user-info" class="user-info" style="display:none">
          <span id="user-display"></span>
        </div>
        <div id="auth-buttons" class="auth-buttons">
          <button id="openAuthBtn" class="secondary">Sign in / Sign up</button>
        </div>
      </div>

      <form id="tradeForm" class="trade-form" style="display:none" autocomplete="off">
        <label for="ingameName">In-game name</label>
        <input id="ingameName" type="text" placeholder="Your in-game name" required />

        <!-- Offer items dropdown -->
        <label>Items you OFFER</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="offer-list">Select offered items ‚ñæ</button>
          <div class="dropdown-content" id="offer-list" aria-hidden="true"></div>
        </div>

        <!-- Diamonds offer -->
        <label for="offerDiamonds">Diamonds you OFFER</label>
        <input id="offerDiamonds" type="number" min="0" value="0" placeholder="0 üíé" />

        <!-- Want items dropdown -->
        <label>Items you WANT</label>
        <div class="dropdown-checkbox">
          <button type="button" class="dropbtn" data-target="want-list">Select wanted items ‚ñæ</button>
          <div class="dropdown-content" id="want-list" aria-hidden="true"></div>
        </div>

        <!-- Diamonds want -->
        <label for="wantDiamonds">Diamonds you WANT</label>
        <input id="wantDiamonds" type="number" min="0" value="0" placeholder="0 üíé" />

        <div class="form-row">
          <button id="postTradeBtn" type="submit" class="primary">Post Trade</button>
          <button id="clearFormBtn" type="button" class="secondary">Clear</button>
        </div>

        <p id="formNote" class="note">You can post one trade every 24 hours.</p>
      </form>
    </section>

    <!-- LIVE TRADES -->
    <section class="live-trades">
      <h2>Live Trades</h2>
      <div id="tradesContainer" class="trades-container"></div>
    </section>
  </main>

  <footer id="footer">
    <p>Copyright &copy; viiru.top & viiru.ee 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a> |
    <a href="tos.html">Terms Of Service</a>
  </footer>

  <!-- Dark Mode Script -->
  <script>
    const toggleButton = document.getElementById('darkModeToggle');
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      toggleButton.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    });
  </script>
  
  <!-- AUTH MODAL -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-inner">
      <button id="closeAuthModal" class="close">‚úï</button>
      <h3>Sign in or Sign up</h3>

      <div class="auth-cols">
        <div class="auth-col">
          <p><strong>Quick:</strong></p>
          <button id="googleSignIn" class="primary">Sign in with Google</button>
        </div>

        <div class="auth-col">
          <p><strong>Email</strong></p>
          <input id="authEmail" type="email" placeholder="Email" />
          <input id="authPassword" type="password" placeholder="Password" />
          <div class="form-row">
            <button id="emailSignIn" class="secondary">Sign In</button>
            <button id="emailSignUp" class="secondary">Create Account</button>
          </div>
          <p class="small">If creating an account, you'll be signed in automatically.</p>
        </div>

        <div class="auth-col">
          <p><strong>Anonymous</strong></p>
          <input id="anonIngameName" type="text" placeholder="In-game name" />
          <button id="anonSignIn" class="secondary">Continue without account</button>
        </div>
      </div>

      <div id="authError" class="auth-error" role="alert"></div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, setDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, onAuthStateChanged, signInAnonymously, updateProfile
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // ---------- Config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
    authDomain: "v11rutop.firebaseapp.com",
    projectId: "v11rutop",
    storageBucket: "v11rutop.firebasestorage.app",
    messagingSenderId: "664984661004",
    appId: "1:664984661004:web:357ea8a60723b000e55229"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const googleProvider = new GoogleAuthProvider();

  // ---------- DOM ----------
  const loginBtn = document.getElementById('loginBtn');
  const openAuthBtn = document.getElementById('openAuthBtn');
  const authModal = document.getElementById('authModal');
  const closeAuthModal = document.getElementById('closeAuthModal');
  const googleSignIn = document.getElementById('googleSignIn');
  const emailSignInBtn = document.getElementById('emailSignIn');
  const emailSignUpBtn = document.getElementById('emailSignUp');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');
  const authError = document.getElementById('authError');
  const anonSignInBtn = document.getElementById('anonSignIn');
  const anonIngameName = document.getElementById('anonIngameName');

  const tradeForm = document.getElementById('tradeForm');
  const postTradeBtn = document.getElementById('postTradeBtn');
  const clearFormBtn = document.getElementById('clearFormBtn');

  const ingameName = document.getElementById('ingameName');
  const offerList = document.getElementById('offer-list');
  const wantList = document.getElementById('want-list');
  const offerDiamonds = document.getElementById('offerDiamonds');
  const wantDiamonds = document.getElementById('wantDiamonds');
  const tradesContainer = document.getElementById('tradesContainer');
  const darkModeToggle = document.getElementById('darkModeToggle');

  // ---------- Items ----------
  const ITEMS = [
    { id: 'sefu_clone', name: 'Sefu Clone' },
    { id: 'sefu', name: 'Sefu' },
    { id: 'aisha_pickaxe', name: 'Aisha Pickaxe' },
    { id: 'freyja_crossbow', name: 'Freyja Crossbow' },
    { id: 'shulker_helmet', name: 'Shulker Helmet' },
    { id: 'shulker_chestplate', name: 'Shulker Chestplate' },
    { id: 'shulker_leggings', name: 'Shulker Leggings' },
    { id: 'shulker_boots', name: 'Shulker Boots' },
    { id: 'corrupted_freyja' , name: 'Corrupted Freyja' },
    { id: 'corrupted_sefu' , name: 'Corrupted Sefu' },
    { id: 'corrupted_abasi' , name: 'Corrupted Abasi' },
    { id: 'corrupted_aisha' , name: 'Corrupted Aisha' },
    { id: 'horus_sword', name: 'Horus Sword' },
    { id: 'horus_pickaxe' , name: 'Horus Pickaxe' },
    { id: 'horus_axe' , name: 'Horus Axe' },
    { id: 'horus_shovel', name: 'Horus Shovel' },
    { id: 'ancient_elytra', name: 'Ancient Elytra' },
    { id: 'horus_helmet', name: 'Horus Helmet' },
    { id: 'horus_chestplate', name: 'Horus Chestplate' },
    { id: 'horus_leggings', name: 'Horus Leggings' },
    { id: 'horus_boots', name: 'Horus Boots' },
    { id: 'ammon_sword', name: 'Ammon Sword' },
    { id : 'ammon_pickaxe', name: 'Ammon Pickaxe' },
    { id : 'ammon_axe', name: 'Ammon Axe' },
    { id : 'ammon_shovel', name: 'Ammon Shovel' },
    { id : 'ammon_helmet', name: 'Ammon Helmet' },
    { id: 'ammon_chestplate', name: 'Ammon Chestplate' },
    { id: 'ammon_leggings' , name: 'Ammon Leggings' },
    { id: 'ammon_boots', name: 'Ammon Boots' },
    { id: 'musa_trident', name: 'Musa Trident' },
    { id: 'musa_pickaxe', name: 'Musa Pickaxe' },
    { id: 'musa_axe', name: 'Musa Axe' },
    { id: 'musa_shovel', name: 'Musa Shovel' },
    { id: 'musa_helmet' , name: 'Musa Helmet' },
    { id: 'musa_chestplate' , name: 'Musa Chestplate' },
    { id: 'musa_leggings' , name: 'Musa Leggings' },
    { id: 'musa_boots' , name: 'Musa Boots' },
    { id : 'anubis_sword' , name: 'Anubis Sword' },
    { id : 'anubis_pickaxe' , name: 'Anubis Pickaxe' },
    { id : 'anubis_axe' , name: 'Anubis Axe' },
    { id : 'anubis_shovel' , name: 'Anubis Shovel' },
    { id : 'anubis_helmet' , name: 'Anubis Helmet' },
    { id : 'anubis_chestplate' , name: 'Anubis Chestplate' },
    { id : 'anubis_leggings' , name: 'Anubis Leggings' },
    { id : 'anubis_boots' , name: 'Anubis Boots' },
    { id : 'anukis_sword' , name: 'Anukis Sword' },
    { id : 'anukis_pickaxe' , name: 'Anukis Pickaxe' },
    { id : 'anukis_axe' , name: 'Anukis Axe' },
    { id : 'anukis_shovel' , name: 'Anukis Shovel' },
    { id : 'anukis_helmet' , name: 'Anukis Helmet' },
    { id : 'anukis_chestplate' , name: 'Anukis Chestplate' },
    { id : 'anukis_leggings' , name: 'Anukis Leggings' },
    { id : 'anukis_boots' , name: 'Anukis Boots' },
    { id : 'freyja_sword' , name: 'Freyja Sword' },
    { id : 'freyja_pickaxe' , name: 'Freyja Pickaxe' },
    { id : 'freyja_axe' , name: 'Freyja Axe' },
    { id : 'freyja_shovel' , name: 'Freyja Shovel' },
    { id : 'freyja_helmet' , name: 'Freyja Helmet' },
    { id : 'freyja_chestplate' , name: 'Freyja Chestplate' },
    { id : 'freyja_leggings' , name: 'Freyja Leggings' },
    { id : 'freyja_boots' , name: 'Freyja Boots' },
    { id : 'freyja_crossbow' , name: 'Freyja Crossbow' },
    { id : 'zalika_sword' , name: 'Zalika Sword' },
    { id : 'zalika_pickaxe' , name: 'Zalika Pickaxe' },
    { id : 'zalika_axe' , name: 'Zalika Axe' },
    { id : 'zalika_shovel' , name: 'Zalika Shovel' },
    { id : 'zalika_helmet' , name: 'Zalika Helmet' },
    { id : 'zalika_chestplate' , name: 'Zalika Chestplate' },
    { id : 'zalika_leggings' , name: 'Zalika Leggings' },
    { id : 'zalika_boots' , name: 'Zalika Boots' },
    { id : 'dragon_sword' , name: 'Dragon Sword' },
    { id : 'dragon_pickaxe' , name: 'Dragon Pickaxe' },
    { id : 'dragon_axe' , name: 'Dragon Axe' },
    { id : 'dragon_shovel' , name: 'Dragon Shovel' },
    { id : 'dragon_helmet' , name: 'Dragon Helmet' },
    { id : 'dragon_chestplate' , name: 'Dragon Chestplate' },
    { id : 'dragon_leggings' , name: 'Dragon Leggings' },
    { id : 'dragon_boots' , name: 'Dragon Boots' }, 
    { id : 'dragon_egg' , name: 'Dragon Egg' },


  ];

  // ---------- Helpers for dropdowns ----------
  function makeItemRow(itemId, itemName, checkboxName) {
    const label = document.createElement('label');
    label.className = 'item-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'item-cb';
    cb.dataset.item = itemId;
    cb.dataset.itemName = itemName;

    const span = document.createElement('span');
    span.className = 'item-name';
    span.textContent = itemName;

    const qty = document.createElement('input');
    qty.type = 'number';
    qty.className = 'item-qty';
    qty.min = 1;
    qty.value = 1;
    qty.disabled = true;
    qty.style.width = '60px';

    cb.addEventListener('change', () => {
      qty.disabled = !cb.checked;
      updateDropdownButtonText(checkboxName);
    });

    qty.addEventListener('input', () => updateDropdownButtonText(checkboxName));

    label.appendChild(cb);
    label.appendChild(span);
    label.appendChild(qty);
    return label;
  }

  function populateItemLists() {
    offerList.innerHTML = '';
    wantList.innerHTML = '';
    ITEMS.forEach(it => {
      offerList.appendChild(makeItemRow(it.id, it.name, 'offer-list'));
      wantList.appendChild(makeItemRow(it.id, it.name, 'want-list'));
    });
  }
  populateItemLists();

  document.querySelectorAll('.dropbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.dataset.target;
      const parent = btn.parentElement;
      parent.classList.toggle('show');
      updateDropdownButtonText(targetId);
    });
  });

  window.addEventListener('click', (e) => {
    document.querySelectorAll('.dropdown-checkbox').forEach(drop => {
      if (!drop.contains(e.target)) drop.classList.remove('show');
    });
  });

  function updateDropdownButtonText(listId) {
    const parent = document.querySelector(`[data-target="${listId}"]`)?.parentElement;
    const btn = parent?.querySelector('.dropbtn');
    if (!btn) return;
    const checked = Array.from(document.querySelectorAll(`#${listId} .item-cb`)).filter(c => c.checked);
    if (checked.length === 0) {
      btn.textContent = (listId === 'offer-list') ? 'Select offered items ‚ñæ' : 'Select wanted items ‚ñæ';
      return;
    }
    const names = checked.map(c => {
      const qty = c.parentElement.querySelector('.item-qty').value || 1;
      return `${qty}√ó ${c.dataset.itemName}`;
    });
    btn.textContent = names.slice(0,3).join(', ') + (names.length > 3 ? ' ‚Ä¶ ‚ñæ' : ' ‚ñæ');
  }

  // ---------- Auth modal ----------
  openAuthBtn.addEventListener('click', () => showAuthModal());
  loginBtn.addEventListener('click', () => {
    if (auth.currentUser) {
      signOut(auth);
    } else {
      showAuthModal();
    }
  });
  closeAuthModal.addEventListener('click', () => hideAuthModal());

  function showAuthModal() {
    authModal.style.display = 'block';
    authModal.setAttribute('aria-hidden','false');
    authError.textContent = '';
  }
  function hideAuthModal() {
    authModal.style.display = 'none';
    authModal.setAttribute('aria-hidden','true');
  }

  // ---------- Sign in ----------
  googleSignIn.addEventListener('click', async () => {
    authError.textContent = '';
    try {
      await signInWithPopup(auth, googleProvider);
      hideAuthModal();
    } catch (err) { authError.textContent = err.message; }
  });

  emailSignInBtn.addEventListener('click', async () => {
    authError.textContent = '';
    try {
      await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value);
      hideAuthModal();
    } catch (err) { authError.textContent = err.message; }
  });

  emailSignUpBtn.addEventListener('click', async () => {
    authError.textContent = '';
    try {
      await createUserWithEmailAndPassword(auth, authEmail.value.trim(), authPassword.value);
      hideAuthModal();
    } catch (err) { authError.textContent = err.message; }
  });

  anonSignInBtn.addEventListener('click', async () => {
    authError.textContent = '';
    const name = anonIngameName.value.trim();
    if (!name) { authError.textContent = 'Enter your in-game name'; return; }
    try {
      const cred = await signInAnonymously(auth);
      await updateProfile(cred.user, { displayName: name });
      hideAuthModal();
    } catch (err) { authError.textContent = err.message; }
  });

  // ---------- Auth state ----------
  onAuthStateChanged(auth, user => {
    if (user) {
      loginBtn.textContent = 'Logout';
      loginBtn.classList.add('logged-in');
      document.getElementById('user-display').textContent = `Signed in: ${user.displayName || user.email || "Anon"}`;
      document.getElementById('user-info').style.display = 'block';
      document.getElementById('auth-buttons').style.display = 'none';
      tradeForm.style.display = 'block';
      if (!ingameName.value) ingameName.value = user.displayName || '';
    } else {
      loginBtn.textContent = 'Login';
      loginBtn.classList.remove('logged-in');
      document.getElementById('user-display').textContent = '';
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('auth-buttons').style.display = 'block';
      tradeForm.style.display = 'none';
    }
  });

  // ---------- 24h cooldown ----------
  async function getLastTradeTime(uid) {
    const snap = await getDoc(doc(db, 'users', uid));
    return snap.exists() ? snap.data().lastTrade || 0 : 0;
  }
  async function setLastTradeTime(uid, ts) {
    await setDoc(doc(db, 'users', uid), { lastTrade: ts }, { merge: true });
  }

  // ---------- Trade posting ----------
  function collectSelectedItems(listId) {
    const rows = Array.from(document.querySelectorAll(`#${listId} .item-row`));
    return rows.filter(r => r.querySelector('.item-cb').checked).map(r => ({
      id: r.querySelector('.item-cb').dataset.item,
      name: r.querySelector('.item-cb').dataset.itemName,
      qty: parseInt(r.querySelector('.item-qty').value) || 1
    }));
  }

  tradeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert('Login required.');

    const last = await getLastTradeTime(user.uid);
    if (Date.now() - last < 24*60*60*1000) {
      return alert('You can only post one trade every 24h.');
    }

    const trade = {
      uid: user.uid,
      authorName: ingameName.value || user.displayName || "Anon",
      offerItems: collectSelectedItems('offer-list'),
      wantItems: collectSelectedItems('want-list'),
      offerDiamonds: parseInt(offerDiamonds.value) || 0,
      wantDiamonds: parseInt(wantDiamonds.value) || 0,
      createdAt: serverTimestamp()
    };

    if (!trade.offerItems.length && !trade.offerDiamonds) return alert('Must offer something.');
    if (!trade.wantItems.length && !trade.wantDiamonds) return alert('Must want something.');

    try {
      await addDoc(collection(db, 'trades'), trade);
      await setLastTradeTime(user.uid, Date.now());
      alert('Trade posted!');
      tradeForm.reset();
      populateItemLists();
    } catch (err) { alert(err.message); }
  });

  clearFormBtn.addEventListener('click', () => {
    tradeForm.reset();
    populateItemLists();
  });

  // ---------- Live trades ----------
  const tradesQuery = query(collection(db, 'trades'), orderBy('createdAt','desc'));
  onSnapshot(tradesQuery, snapshot => {
    tradesContainer.innerHTML = '';
    snapshot.forEach(docSnap => {
      const t = docSnap.data();
      const card = document.createElement('div');
      card.className = 'trade-card';
      const formatList = (arr) => arr.map(it => `${it.qty}√ó ${it.name}`).join(', ') || '‚Äî';
      card.innerHTML = `
        <h4>${t.authorName || 'Unknown'}</h4>
        <p><strong>Offers:</strong> ${formatList(t.offerItems)} ${t.offerDiamonds ? 'üíé'+t.offerDiamonds : ''}</p>
        <p><strong>Wants:</strong> ${formatList(t.wantItems)} ${t.wantDiamonds ? 'üíé'+t.wantDiamonds : ''}</p>
        <p class="timestamp">${t.createdAt?.toDate().toLocaleString() || ''}</p>
      `;
      tradesContainer.appendChild(card);
    });
  });

  // ---------- Dark mode ----------
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  </script>
</body>
</html>
