<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="trades.css">
    <link rel="icon" href="https://github.com/CallMeViiru/Website/blob/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png">
</head>
<body>

<header id="header">
    <img src="https://github.com/CallMeViiru/Website/blob/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png" alt="Viiru Logo" id="HIcon">
    <h1 id="HH1">Viiru</h1>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="Store.html">Store</a></li>
            <li><a href="Socials.html">Socials</a></li>
            <li><a href="about.html">About</a></li>
        </ul>
    </nav>
    <button id="loginBtn">Login</button>
</header>

<section class="login-section">
    <h2>Post a Trade</h2>
    <p id="loginMessage">You must log in to post trades</p>
    <input type="text" id="username" placeholder="Ingame Username">

    <h3>Offer Items</h3>
    <div class="dropdown" id="offerDropdown">
        <button class="dropbtn">Select items</button>
        <div class="dropdown-content" id="offerContent"></div>
    </div>
    <label>ðŸ’Ž Diamonds Offered:</label>
    <input type="number" id="offerDiamonds" min="0" value="0">

    <h3>Request Items</h3>
    <div class="dropdown" id="requestDropdown">
        <button class="dropbtn">Select items</button>
        <div class="dropdown-content" id="requestContent"></div>
    </div>
    <label>ðŸ’Ž Diamonds Requested:</label>
    <input type="number" id="requestDiamonds" min="0" value="0">

    <button id="postTradeBtn">Post Trade</button>
    <p id="tradeMessage"></p>
</section>

<section class="live-trades">
    <h2>Live Trades</h2>
    <div id="tradesContainer"></div>
</section>

<footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a>
    <a href="tos.html">Terms of Service</a>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
        authDomain: "v11rutop.firebaseapp.com",
        projectId: "v11rutop",
        storageBucket: "v11rutop.firebasestorage.app",
        messagingSenderId: "664984661004",
        appId: "1:664984661004:web:357ea8a60723b000e55229",
        measurementId: "G-DMPEGNPVEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const loginBtn = document.getElementById("loginBtn");
    const loginMessage = document.getElementById("loginMessage");

    let currentUser = null;
    let cooldowns = {};

    // Login/logout
    loginBtn.addEventListener("click", async () => {
        if (!currentUser) {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } else {
            await signOut(auth);
        }
    });

    onAuthStateChanged(auth, user => {
        currentUser = user;
        if (user) {
            loginMessage.textContent = "Logged in as " + user.displayName;
            loginBtn.textContent = "Logout";
        } else {
            loginMessage.textContent = "You must log in to post trades";
            loginBtn.textContent = "Login";
        }
    });

    // Dropdown setup
    const itemsList = ["Sword","Helmet","Shield","Bow","Armor"];
    function createDropdown(dropdownId, contentId){
        const contentDiv = document.getElementById(contentId);
        itemsList.forEach(item=>{
            const label = document.createElement("label");
            label.innerHTML = `<input type="checkbox" value="${item}"> ${item}`;
            contentDiv.appendChild(label);
        });
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.querySelector(".dropbtn");
        button.addEventListener("click", ()=>dropdown.classList.toggle("show"));
    }
    createDropdown("offerDropdown","offerContent");
    createDropdown("requestDropdown","requestContent");

    function getSelectedItems(contentId){
        const contentDiv = document.getElementById(contentId);
        const selected = [];
        contentDiv.querySelectorAll("input[type=checkbox]").forEach(cb=>{
            if(cb.checked) selected.push({item:cb.value, amount:1});
        });
        return selected;
    }

    // 24h cooldown in ms
    const COOLDOWN = 24*60*60*1000;

    document.getElementById("postTradeBtn").addEventListener("click", async ()=>{
        if(!currentUser) { alert("You must log in!"); return; }

        const username = document.getElementById("username").value.trim();
        const offerItems = getSelectedItems("offerContent");
        const requestItems = getSelectedItems("requestContent");
        const offerDiamonds = parseInt(document.getElementById("offerDiamonds").value) || 0;
        const requestDiamonds = parseInt(document.getElementById("requestDiamonds").value) || 0;

        if(!username || (offerItems.length===0 && offerDiamonds===0) || (requestItems.length===0 && requestDiamonds===0)){
            alert("Fill in all required fields.");
            return;
        }

        // cooldown check
        const tradesRef = collection(db,"trades");
        const q = query(tradesRef, where("uid","==",currentUser.uid), orderBy("timestamp","desc"));
        const userTrades = await getDocs(q);
        if(!userTrades.empty){
            const lastTrade = userTrades.docs[0].data();
            const now = Date.now();
            if(now - lastTrade.timestamp.toMillis() < COOLDOWN){
                alert("You must wait 24h before posting another trade.");
                return;
            }
        }

        await addDoc(tradesRef,{
            uid: currentUser.uid,
            username: username,
            offerItems: offerItems,
            requestItems: requestItems,
            offerDiamonds: offerDiamonds,
            requestDiamonds: requestDiamonds,
            timestamp: serverTimestamp()
        });

        document.getElementById("tradeMessage").textContent = "Trade posted successfully!";
    });

    // Live updates
    const tradesContainer = document.getElementById("tradesContainer");
    const tradesRef = collection(db,"trades");
    const tradesQuery = query(tradesRef, orderBy("timestamp","desc"));
    onSnapshot(tradesQuery, snapshot=>{
        tradesContainer.innerHTML = "";
        snapshot.forEach(doc=>{
            const t = doc.data();
            const div = document.createElement("div");
            div.classList.add("trade-item");
            div.innerHTML = `
                <strong>${t.username}</strong><br>
                Offer: ${t.offerItems.map(i=>i.item).join(", ")} ðŸ’Ž${t.offerDiamonds}<br>
                Wants: ${t.requestItems.map(i=>i.item).join(", ")} ðŸ’Ž${t.requestDiamonds}
            `;
            tradesContainer.appendChild(div);
        });
    });
</script>

</body>
</html>
