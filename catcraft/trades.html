<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="trades.css">
    <link rel="icon" href="https://raw.githubusercontent.com/CallMeViiru/Website/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png">
</head>
<body>
    <header id="header">
        <img src="https://raw.githubusercontent.com/CallMeViiru/Website/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png" alt="Viiru Logo" id="HIcon">
        <h1 id="HH1">Viiru</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="Store.html">Store</a></li>
                <li><a href="Socials.html">Socials</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
        <button id="loginBtn">Login</button>
    </header>

    <section class="trade-section">
        <h2>Post Your Trade</h2>
        <form id="tradeForm">
            <input type="text" id="username" placeholder="In-game Username" required>

            <div class="trade-group">
                <label>Offer Items:</label>
                <div id="offerCheckboxes" class="checkbox-container"></div>
            </div>

            <div class="trade-group">
                <label>Offer Diamonds:</label>
                <input type="number" id="offerDiamonds" placeholder="0" min="0">
            </div>

            <div class="trade-group">
                <label>Request Items:</label>
                <div id="requestCheckboxes" class="checkbox-container"></div>
            </div>

            <div class="trade-group">
                <label>Request Diamonds:</label>
                <input type="number" id="requestDiamonds" placeholder="0" min="0">
            </div>

            <button type="submit">Post Trade</button>
            <p id="status"></p>
        </form>
    </section>

    <section class="live-trades">
        <h2>Live Trades</h2>
        <div id="tradesList"></div>
    </section>

    <footer id="footer">
        <p>Copyright &copy; viiru.top 2025</p>
        <a href="privacypolicy.html">Privacy Policy</a>
        <a href="tos.html">Terms of Service</a>
    </footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
  authDomain: "v11rutop.firebaseapp.com",
  projectId: "v11rutop",
  storageBucket: "v11rutop.firebasestorage.app",
  messagingSenderId: "664984661004",
  appId: "1:664984661004:web:357ea8a60723b000e55229",
  measurementId: "G-DMPEGNPVEN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Items list
const items = ["Sword","Helmet","Shield","Bow","Armor"];

function createCheckboxes(containerId, items){
    const container = document.getElementById(containerId);
    items.forEach(item=>{
        const div = document.createElement("div");
        div.className="checkbox-item";
        div.innerHTML=`<label><input type="checkbox" value="${item}"> ${item}</label>`;
        container.appendChild(div);
    });
}

createCheckboxes("offerCheckboxes", items);
createCheckboxes("requestCheckboxes", items);

// Auth
let currentUser = null;
const loginBtn = document.getElementById("loginBtn");

loginBtn.addEventListener("click", ()=>{
    if(currentUser){
        signOut(auth);
    } else {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(err=>alert(err.message));
    }
});

onAuthStateChanged(auth, user=>{
    currentUser = user;
    loginBtn.textContent = user ? "Logout" : "Login";
    document.getElementById("username").value = user ? user.displayName : "";
});

// Post trade
const tradeForm = document.getElementById("tradeForm");
const status = document.getElementById("status");

tradeForm.addEventListener("submit", async e=>{
    e.preventDefault();
    if(!currentUser){ status.textContent="You must log in!"; return; }

    const username = document.getElementById("username").value;
    const offerSelected = Array.from(document.querySelectorAll("#offerCheckboxes input:checked")).map(i=>i.value);
    const requestSelected = Array.from(document.querySelectorAll("#requestCheckboxes input:checked")).map(i=>i.value);
    const offerDiamonds = parseInt(document.getElementById("offerDiamonds").value) || 0;
    const requestDiamonds = parseInt(document.getElementById("requestDiamonds").value) || 0;

    const tradesRef = collection(db,"trades");
    const now = new Date();
    const last24 = new Date(now.getTime()-24*60*60*1000);

    const q = query(tradesRef, where("uid","==",currentUser.uid), where("timestamp",">",last24));
    const recent = await getDocs(q);
    if(!recent.empty){ status.textContent="You can post once every 24h."; return; }

    await addDoc(tradesRef,{
        uid: currentUser.uid,
        username,
        offerItems: offerSelected,
        offerDiamonds,
        requestItems: requestSelected,
        requestDiamonds,
        timestamp: serverTimestamp()
    });
    status.textContent="Trade posted!";
    tradeForm.reset();
});

// Live trades
const tradesList = document.getElementById("tradesList");
const tradesRef = collection(db,"trades");
const tradesQuery = query(tradesRef, orderBy("timestamp","desc"));

onSnapshot(tradesQuery, snapshot=>{
    tradesList.innerHTML="";
    snapshot.forEach(doc=>{
        const t=doc.data();
        const div = document.createElement("div");
        div.className="trade-box";
        div.innerHTML=`<strong>${t.username}</strong><br>
                       Offer: ${t.offerItems.join(", ")} + ðŸ’Ž${t.offerDiamonds}<br>
                       Request: ${t.requestItems.join(", ")} + ðŸ’Ž${t.requestDiamonds}`;
        tradesList.appendChild(div);
    });
});
</script>
</body>
</html>

