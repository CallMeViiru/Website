<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viiru | Trades</title>
  <link rel="icon" type="image/png" href="Images/Viiru.png">
  <link rel="stylesheet" href="trades.css">
</head>
<body>
  <!-- Header -->
  <header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon">
    <h1 id="HH1">Viiru</h1>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="store.html">Store</a></li>
        <li><a href="socials.html">Socials</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="trades.html" class="active">Trades</a></li>
      </ul>
    </nav>
    <button id="loginBtn">Login</button>
  </header>

  <!-- Trade Form -->
  <section class="trade-section">
    <h2>Post a Trade</h2>
    <form id="tradeForm">
      <input type="text" id="username" placeholder="In-game username" required>

      <label for="offerItems">What do you offer?</label>
      <div class="dropdown-checkbox">
        <button type="button" class="dropdown-btn">Select Items ▼</button>
        <div class="dropdown-content" id="offerItems">
          <label><input type="checkbox" value="Sword"> Sword ⚔️</label>
          <label><input type="checkbox" value="Helmet"> Helmet ⛑️</label>
          <label><input type="checkbox" value="Pickaxe"> Pickaxe ⛏️</label>
        </div>
      </div>
      <input type="number" id="offerDiamonds" placeholder="Diamonds 💎 (optional)" min="0">

      <label for="wantItems">What do you want?</label>
      <div class="dropdown-checkbox">
        <button type="button" class="dropdown-btn">Select Items ▼</button>
        <div class="dropdown-content" id="wantItems">
          <label><input type="checkbox" value="Sword"> Sword ⚔️</label>
          <label><input type="checkbox" value="Helmet"> Helmet ⛑️</label>
          <label><input type="checkbox" value="Pickaxe"> Pickaxe ⛏️</label>
        </div>
      </div>
      <input type="number" id="wantDiamonds" placeholder="Diamonds 💎 (optional)" min="0">

      <button type="submit">Post Trade</button>
    </form>
  </section>

  <!-- Live Trades -->
  <section class="live-trades">
    <h2>Live Trades</h2>
    <div id="tradesList"></div>
  </section>

  <footer id="footer">
    <p>Copyright © viiru.top 2025</p>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
      authDomain: "v11rutop.firebaseapp.com",
      projectId: "v11rutop",
      storageBucket: "v11rutop.firebasestorage.app",
      messagingSenderId: "664984661004",
      appId: "1:664984661004:web:357ea8a60723b000e55229",
      measurementId: "G-DMPEGNPVEN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const tradeForm = document.getElementById("tradeForm");
    const tradesList = document.getElementById("tradesList");

    // 🔹 Login system
    loginBtn.addEventListener("click", async () => {
      if (auth.currentUser) {
        await signOut(auth);
      } else {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        loginBtn.textContent = "Logout";
        tradeForm.style.display = "block";
      } else {
        loginBtn.textContent = "Login";
        tradeForm.style.display = "none";
      }
    });

    // 🔹 Post trade
    tradeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const offerItems = [...document.querySelectorAll("#offerItems input:checked")].map(i => i.value);
      const wantItems = [...document.querySelectorAll("#wantItems input:checked")].map(i => i.value);
      const offerDiamonds = document.getElementById("offerDiamonds").value;
      const wantDiamonds = document.getElementById("wantDiamonds").value;

      if (!auth.currentUser) {
        alert("You must be logged in to post a trade!");
        return;
      }

      await addDoc(collection(db, "trades"), {
        username,
        offerItems,
        offerDiamonds,
        wantItems,
        wantDiamonds,
        timestamp: serverTimestamp()
      });

      tradeForm.reset();
    });

    // 🔹 Live trades
    const q = query(collection(db, "trades"), orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
      tradesList.innerHTML = "";
      snapshot.forEach(doc => {
        const trade = doc.data();
        tradesList.innerHTML += `
          <div class="trade-card">
            <p><strong>${trade.username}</strong></p>
            <p>Offers: ${trade.offerItems?.join(", ") || "None"} ${trade.offerDiamonds ? `+ ${trade.offerDiamonds} 💎` : ""}</p>
            <p>Wants: ${trade.wantItems?.join(", ") || "None"} ${trade.wantDiamonds ? `+ ${trade.wantDiamonds} 💎` : ""}</p>
          </div>
        `;
      });
    });
  </script>
</body>
</html>
