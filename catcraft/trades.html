<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viiru | Trades</title>
    <link rel="stylesheet" href="trades.css">
    <link rel="icon" type="image/x-icon" href="Images/Viiru.png">
</head>
<body>

<header id="header">
    <img src="Images/Viiru.png" alt="Viiru Logo" id="HIcon">
    <h1 id="HH1">Viiru</h1>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="Store.html">Store</a></li>
            <li><a href="Socials.html">Socials</a></li>
            <li><a href="about.html">About</a></li>
        </ul>
    </nav>
    <button id="loginBtn">Login</button>
</header>

<section class="login-warning">
    <p id="loginMessage">You must be logged in to post trades.</p>
</section>

<section class="trade-section">
    <h2>Post a Trade</h2>

    <input type="text" id="username" placeholder="Your in-game username">

    <div class="trade-inputs">
        <label>Offer Items:</label>
        <select id="offerItems" multiple></select>

        <label>Offer Diamonds ðŸ’Ž:</label>
        <input type="number" id="offerDiamonds" placeholder="Amount of diamonds">

        <label>Request Items:</label>
        <select id="requestItems" multiple></select>

        <label>Request Diamonds ðŸ’Ž:</label>
        <input type="number" id="requestDiamonds" placeholder="Amount of diamonds">
    </div>

    <button id="postTradeBtn">Post Trade</button>
</section>

<section class="live-trades">
    <h2>Live Trades</h2>
    <div id="tradeList"></div>
</section>

<footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="privacypolicy.html">Privacy Policy</a>
    <a href="tos.html">Terms of Service</a>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
    authDomain: "v11rutop.firebaseapp.com",
    projectId: "v11rutop",
    storageBucket: "v11rutop.firebasestorage.app",
    messagingSenderId: "664984661004",
    appId: "1:664984661004:web:357ea8a60723b000e55229",
    measurementId: "G-DMPEGNPVEN"
};

// Initialize
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Elements
const loginBtn = document.getElementById('loginBtn');
const postTradeBtn = document.getElementById('postTradeBtn');
const tradeList = document.getElementById('tradeList');
const usernameInput = document.getElementById('username');
const offerItemsSelect = document.getElementById('offerItems');
const requestItemsSelect = document.getElementById('requestItems');
const offerDiamondsInput = document.getElementById('offerDiamonds');
const requestDiamondsInput = document.getElementById('requestDiamonds');
const loginMessage = document.getElementById('loginMessage');

let currentUser = null;
let cooldowns = {}; // local cache

// Example items JSON
const items = ["Sword", "Helmet", "Shield", "Potion", "Bow"];
items.forEach(item => {
    const option1 = document.createElement("option");
    option1.value = item;
    option1.textContent = item;
    offerItemsSelect.appendChild(option1);

    const option2 = document.createElement("option");
    option2.value = item;
    option2.textContent = item;
    requestItemsSelect.appendChild(option2);
});

// Login/logout
loginBtn.addEventListener('click', async () => {
    if(currentUser){
        await signOut(auth);
    } else {
        await signInWithPopup(auth, provider);
    }
});

// Auth state change
onAuthStateChanged(auth, user => {
    currentUser = user;
    if(user){
        loginBtn.textContent = "Logout";
        loginMessage.style.display = "none";
    } else {
        loginBtn.textContent = "Login";
        loginMessage.style.display = "block";
    }
});

// Post trade
postTradeBtn.addEventListener('click', async () => {
    if(!currentUser){
        alert("You must be logged in!");
        return;
    }

    const username = usernameInput.value.trim();
    if(!username){
        alert("Enter your in-game username.");
        return;
    }

    const offerItems = Array.from(offerItemsSelect.selectedOptions).map(o=>o.value);
    const requestItems = Array.from(requestItemsSelect.selectedOptions).map(o=>o.value);
    const offerDiamonds = Number(offerDiamondsInput.value || 0);
    const requestDiamonds = Number(requestDiamondsInput.value || 0);

    const now = Date.now();
    const lastTrade = cooldowns[currentUser.uid] || 0;
    if(now - lastTrade < 24*60*60*1000){
        alert("You can post only once every 24 hours.");
        return;
    }

    try {
        await addDoc(collection(db, "trades"), {
            uid: currentUser.uid,
            username,
            offerItems,
            requestItems,
            offerDiamonds,
            requestDiamonds,
            timestamp: serverTimestamp()
        });
        cooldowns[currentUser.uid] = now;
        alert("Trade posted!");
    } catch(e) {
        console.error(e);
        alert("Failed to post trade.");
    }
});

// Live trades listener
const q = query(collection(db, "trades"), orderBy("timestamp", "desc"));
onSnapshot(q, snapshot => {
    tradeList.innerHTML = "";
    snapshot.forEach(doc => {
        const data = doc.data();
        const tradeDiv = document.createElement("div");
        tradeDiv.className = "trade-box";
        tradeDiv.innerHTML = `
            <strong>${data.username}</strong><br>
            Offers: ${data.offerItems.join(", ")} ${data.offerDiamonds>0? `ðŸ’Ž${data.offerDiamonds}` : ''}<br>
            Wants: ${data.requestItems.join(", ")} ${data.requestDiamonds>0? `ðŸ’Ž${data.requestDiamonds}` : ''}<br>
            <em>${data.timestamp?.toDate().toLocaleString() || ''}</em>
        `;
        tradeList.appendChild(tradeDiv);
    });
});
</script>

</body>
</html>

