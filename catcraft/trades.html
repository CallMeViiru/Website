<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viiru | Trades</title>
  <link rel="stylesheet" href="trades.css" />
  <link rel="icon" href="https://github.com/CallMeViiru/Website/blob/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png" />
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVJgqD79MXrKbU2okML4wzlMym7yaLxio",
      authDomain: "v11rutop.firebaseapp.com",
      projectId: "v11rutop",
      storageBucket: "v11rutop.firebasestorage.app",
      messagingSenderId: "664984661004",
      appId: "1:664984661004:web:357ea8a60723b000e55229"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.firebaseData = { db, auth }; // expose for scripts
  </script>
</head>
<body>

  <header id="header">
    <img src="https://github.com/CallMeViiru/Website/blob/b0f76f1077e3d3c535c41fc2a11e10c69f4eb62d/Images/Viiru.png" id="HIcon" />
    <h1 id="HH1">Viiru</h1>
    <nav>
      <ul>
        <li><a href="https://www.viiru.top/">Home</a></li>
        <li><a href="https://www.viiru.top/Store">Store</a></li>
        <li><a href="https://www.viiru.top/Socials">Socials</a></li>
        <li><a href="https://www.viiru.top/about">About</a></li>
      </ul>
    </nav>
    <button id="darkModeToggle">üåô</button>
  </header>

  <section class="trade-section">
    <h2>Post Your CatCraft Trade</h2>

    <div id="login-section">
      <button id="login-btn">Login</button>
    </div>

    <form id="trade-form" style="display:none">
      <input type="text" id="username" placeholder="In-game Name" required />

      <div class="dropdown-checkbox">
        <button type="button" class="dropbtn">Items You Offer</button>
        <div class="dropdown-content" id="offer-items">
          <!-- JS populates items -->
        </div>
      </div>
      <input type="number" id="offer-diamonds" placeholder="Diamonds You Offer üíé" min="0" />

      <div class="dropdown-checkbox">
        <button type="button" class="dropbtn">Items You Want</button>
        <div class="dropdown-content" id="want-items">
          <!-- JS populates items -->
        </div>
      </div>
      <input type="number" id="want-diamonds" placeholder="Diamonds You Want üíé" min="0" />

      <button type="submit">Post Trade</button>
    </form>
  </section>

  <section class="live-trades">
    <h2>Live Trades</h2>
    <div id="trade-list"></div>
  </section>

  <footer id="footer">
    <p>Copyright &copy; viiru.top 2025</p>
    <a href="https://www.viiru.top/privacypolicy">Privacy Policy</a>
    <a href="https://www.viiru.top/tos">Terms of Service</a>
  </footer>

  <script type="module">
    import { firebaseData } from './trades.html';
    const { db, auth } = firebaseData;
    const loginBtn = document.getElementById('login-btn');
    const tradeForm = document.getElementById('trade-form');
    const tradeList = document.getElementById('trade-list');

    let currentUser = null;
    const provider = new firebaseData.auth.GoogleAuthProvider();

    const ITEMS = ['Sword','Helmet','Shield','Potion','Bow','Armor'];
    function populateCheckboxes(containerId){
      const container = document.getElementById(containerId);
      ITEMS.forEach(item=>{
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${item}"> ${item}`;
        container.appendChild(label);
      });
    }
    populateCheckboxes('offer-items');
    populateCheckboxes('want-items');

    // dropdown toggle
    document.querySelectorAll('.dropbtn').forEach(btn=>{
      btn.addEventListener('click',()=>{ btn.parentElement.classList.toggle('show'); });
    });
    window.addEventListener('click', e=>{
      document.querySelectorAll('.dropdown-checkbox').forEach(drop=>{
        if(!drop.contains(e.target)) drop.classList.remove('show');
      });
    });

    // Login
    loginBtn.addEventListener('click', ()=>{
      if(currentUser){
        auth.signOut();
      } else {
        firebaseData.auth.signInWithPopup(auth, provider)
          .then(result=>{
            currentUser=result.user;
            loginBtn.textContent='Logout';
            tradeForm.style.display='block';
          });
      }
    });
    auth.onAuthStateChanged(user=>{
      if(user){
        currentUser=user;
        loginBtn.textContent='Logout';
        tradeForm.style.display='block';
      } else {
        currentUser=null;
        loginBtn.textContent='Login';
        tradeForm.style.display='none';
      }
    });

    // Post trade
    tradeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser) return alert("Login required!");

      const username = document.getElementById('username').value;
      const offerItems = Array.from(document.querySelectorAll('#offer-items input:checked')).map(i=>i.value);
      const wantItems = Array.from(document.querySelectorAll('#want-items input:checked')).map(i=>i.value);
      const offerDiamonds = parseInt(document.getElementById('offer-diamonds').value) || 0;
      const wantDiamonds = parseInt(document.getElementById('want-diamonds').value) || 0;

      const trade = {
        username,
        offerItems,
        wantItems,
        offerDiamonds,
        wantDiamonds,
        timestamp: Date.now()
      };

      try{
        await addDoc(collection(db,'trades'), trade);
        loadTrades();
        tradeForm.reset();
        alert("Trade posted!");
      }catch(err){ console.error(err); }
    });

    // Load trades
    async function loadTrades(){
      tradeList.innerHTML='';
      const q = query(collection(db,'trades'), orderBy('timestamp','desc'));
      const snapshot = await getDocs(q);
      snapshot.forEach(doc=>{
        const t = doc.data();
        const card = document.createElement('div');
        card.className='trade-card';
        card.innerHTML=`
          <h4>${t.username}</h4>
          <p>Offer: ${t.offerItems.join(', ')} üíé${t.offerDiamonds}</p>
          <p>Want: ${t.wantItems.join(', ')} üíé${t.wantDiamonds}</p>
        `;
        tradeList.appendChild(card);
      });
    }

    loadTrades();

    // Dark mode
    const toggleButton = document.getElementById('darkModeToggle');
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      toggleButton.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    });
  </script>
</body>
</html>
